<% title = "Meus livros"; %>
<% // `dates` chega do middleware em `index.js` e é usada para popular o filtro lateral %>
<% let datesList = (typeof dates !== 'undefined' && dates) ? dates : []; %>

<!-- Home: barra do usuário (mobile only) -->

<% if (user) { %>
  <div class="home-userbar mobile-only">
    <div class="home-userbar-center">Olá, <strong><%= user.name %></strong></div>
    <a class="btn ghost small home-userbar-right" href="/logout">Sair</a>
  </div>
<% } %>

<!-- Topo: busca + botão de adicionar livro -->
<div class="top-row">
  <form action="/search" class="search-form" method="get">
    <input name="q" placeholder="Pesquisar título ou autor" value="<%= search || '' %>">
    <button type="submit" class="btn primary">Buscar</button>
  </form>

  <a href="/books/add" class="btn primary add-book">Adicionar livro</a>
</div>

<!-- FILTRO LATERAL -->

<aside class="date-filter" id="dateFilter">
  <div class="date-filter-head">
    <h3>Filtrar por data</h3>
    <button class="icon-btn mobile-only" type="button" onclick="closeFilterDrawer()">✕</button>
  </div>

  <% // map: {year: {month: [day,day...]}}
    const map = {};
    datesList.forEach(d => {
      const y = String(parseInt(d.year));
      const mNum = parseInt(d.month);
      const dayNum = parseInt(d.day);

      if (!y || Number.isNaN(mNum) || Number.isNaN(dayNum)) return;

      const m = String(mNum).padStart(2,'0');
      const day = String(dayNum).padStart(2,'0');

      if(!map[y]) map[y] = {};
      if(!map[y][m]) map[y][m] = [];
      if(!map[y][m].includes(day)) map[y][m].push(day);
    });

    const years = Object.keys(map).sort((a,b)=>Number(b)-Number(a));
    years.forEach(y=>{
      Object.keys(map[y]).forEach(m=>{
        map[y][m].sort((a,b)=>Number(b)-Number(a));
      });
    });
  %>

  <% if (years.length === 0) { %>
    <div class="muted">Nenhuma data registrada</div>
  <% } %>

  <% years.forEach(year => { 
      const months = Object.keys(map[year]).sort((a,b)=>Number(b)-Number(a));
  %>
    <div class="year-block">
      <button class="year-btn" type="button" onclick="toggleYear('<%= year %>')">
        <%= year %>
      </button>

      <div id="year-<%= year %>" class="months hidden">
        <% months.forEach(month => { %>
          <button class="month-btn" type="button" onclick="toggleMonth('<%= year %>','<%= month %>')">
            <%= new Date(2020, Number(month)-1, 1).toLocaleString('pt-BR', { month: 'long' }) %>
          </button>

          <div id="month-<%= year %>-<%= month %>" class="days hidden">
            <% map[year][month].forEach(day => { %>
              <a class="day-link" href="/filter/date/<%= year %>/<%= Number(month) %>/<%= Number(day) %>">
                <%= day %>/<%= month %>/<%= year %>
              </a>
            <% }) %>
          </div>
        <% }) %>

        <a href="/filter/date/<%= year %>" class="month-link month-all">
          Ver todos de <%= year %>
        </a>
      </div>
    </div>
  <% }) %>

  <div class="mobile-only" style="margin-top:14px;">
    <!-- Botão de logout mobile only dentro do drawer -->
    <a href="/logout" class="btn ghost full">Sair</a>
  </div>
</aside>

<script>
  function toggleYear(year){
    const el = document.getElementById("year-" + year);
    if(!el) return;
    el.classList.toggle("hidden");

    if(el.classList.contains("hidden")){
      document.querySelectorAll(`[id^="month-${year}-"]`).forEach(m => m.classList.add("hidden"));
    }
  }

  function toggleMonth(year, month){
    const el = document.getElementById(`month-${year}-${month}`);
    if(!el) return;
    el.classList.toggle("hidden");
  }

  function closeFilterDrawer(){
    const filter = document.getElementById("dateFilter");
    const overlay = document.getElementById("overlay");
    filter?.classList.remove("open");
    overlay?.classList.remove("open");
    document.body.classList.remove("no-scroll");
  }
</script>

<section class="books-grid">
  <% if (!books || books.length === 0) { %>
    <div class="empty">Nenhum livro cadastrado.</div>
  <% } %>

  <% books.forEach(book => { %>
    <article class="card">

      <div class="cover-wrap">
        <% if (book.cover_url) { %>
          <img src="<%= book.cover_url %>" alt="Capa de <%= book.title %>">
        <% } else { %>
          <img src="/images/placeholder.png" alt="Sem capa">
        <% } %>
      </div>

      <div class="card-body">
        <h3><%= book.title %></h3>
        <p class="muted">por <%= book.author || '—' %></p>

        <% if (book.rating) { %>
          <p class="rating">
            <%
              const fullStars = '★★★★★';
              const emptyStars = '☆☆☆☆☆';
            %>
            <span class="stars">
              <%= fullStars.slice(0, book.rating) + emptyStars.slice(book.rating) %>
            </span>
          </p>
        <% } %>

        <% if (book.read_date) { %>
          <p class="muted">
            Lido em:
            <strong><%= new Date(book.read_date).toLocaleDateString("pt-BR") %></strong>
          </p>
        <% } %>

        <p class="notes"><%= book.notes || "Sem notas" %></p>
      </div>

      <div class="card-actions">
        <a class="btn small" href="/books/edit/<%= book.id %>">Editar</a>
        <a class="btn small danger" href="/books/delete/<%= book.id %>">Excluir</a>
      </div>

    </article>
  <% }) %>
</section>

<script>
  // Abre/fecha os meses dentro de um ano (desktop e mobile)
  function toggleYear(year){
    const el = document.getElementById("year-" + year);
    if(!el) return;
    el.classList.toggle("hidden");
  }
</script>
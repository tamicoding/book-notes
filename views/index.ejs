<% title = "Meus livros"; %>

<% let datesList = (typeof dates !== 'undefined' && dates) ? dates : []; %>

<!-- top row: pesquisa centralizada + botão adicionar -->
<div class="top-row centered-search">
  <form action="/search" class="search-form" method="get">
    <input name="q" placeholder="Pesquisar título ou autor" value="<%= search || '' %>">
    <button type="submit">Buscar</button>
  </form>

  <a href="/books/add" class="btn add-btn">Adicionar</a>
</div>

<!-- FILTRO LATERAL -->
<aside class="date-filter">
  <h3>Filtrar por data</h3>

  <% 
    const grouped = {};
    (datesList || []).forEach(d => {
      if (!d.year) return;
      const y = String(parseInt(d.year));
      const m = parseInt(d.month);
      if (!grouped[y]) grouped[y] = [];
      if (!grouped[y].includes(m)) grouped[y].push(m);
    });

    Object.keys(grouped).forEach(y => grouped[y].sort((a,b)=>b-a));
  %>

  <% if (Object.keys(grouped).length === 0) { %>
    <div class="muted">Nenhuma data registrada</div>
  <% } %>

  <% Object.keys(grouped).forEach(year => { %>
    <div class="year-block">
      <button class="year-btn" onclick="toggleYear('<%= year %>')">
        <%= year %>
      </button>

      <div id="year-<%= year %>" class="months hidden">
        <% grouped[year].forEach(month => { %>
          <a href="/filter/date/<%= year %>/<%= month %>" class="month-link">
            <%= new Date(2020, month-1, 1).toLocaleString('pt-BR', { month: 'long' }) %>
          </a>
        <% }) %>

        <a href="/filter/date/<%= year %>" class="month-link" style="margin-top:8px; font-weight:600;">
          Ver todos de <%= year %>
        </a>
      </div>
    </div>
  <% }) %>
</aside>

<section class="books-grid">
  <% if (!books || books.length === 0) { %>
    <div class="empty">Nenhum livro cadastrado.</div>
  <% } %>

  <% books.forEach(book => { %>
    <article class="card">

      <div class="cover-wrap">
        <% if (book.cover_url) { %>
          <img src="<%= book.cover_url %>" alt="Capa de <%= book.title %>">
        <% } else { %>
          <img src="/images/placeholder.png" alt="Sem capa">
        <% } %>
      </div>

      <div class="card-body">
        <h3><%= book.title %></h3>
        <p class="muted">por <%= book.author || '—' %></p>

        <% if (book.rating) { %>
          <p class="rating">
            <% 
              const fullStars = '★★★★★';
              const emptyStars = '☆☆☆☆☆';
            %>
            <span class="stars">
              <%= fullStars.slice(0, book.rating) + emptyStars.slice(book.rating) %>
            </span>
          </p>
        <% } %>

        <% if (book.read_date) { %>
          <p class="muted">
            Lido em:
            <strong><%= new Date(book.read_date).toLocaleDateString("pt-BR") %></strong>
          </p>
        <% } %>

        <p class="notes"><%= book.notes || "Sem notas" %></p>
      </div>

      <div class="card-actions">
        <a class="btn small" href="/books/edit/<%= book.id %>">Editar</a>
        <a class="btn small danger" href="/books/delete/<%= book.id %>">Excluir</a>
      </div>

    </article>
  <% }) %>
</section>

<script>
  function toggleYear(year){
    const el = document.getElementById("year-" + year);
    if (!el) return;
    el.classList.toggle("hidden");
  }
</script>
